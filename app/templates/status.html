<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semgrep ‚Üí Linear Integration</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --accent-primary: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-orange: #d29922;
            --accent-purple: #a371f7;
            --accent-cyan: #56d4dd;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border-color: #30363d;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top left, rgba(88, 166, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(163, 113, 247, 0.08) 0%, transparent 50%);
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 3rem 2rem; }
        
        header { text-align: center; margin-bottom: 3rem; }
        
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .logo { font-size: 2.5rem; }
        
        h1 {
            font-size: 2rem; font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        
        .subtitle { color: var(--text-secondary); margin-top: 0.5rem; font-size: 1.1rem; }
        
        .card {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;
        }
        
        .card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .card-header h2 { font-size: 1.25rem; font-weight: 600; }
        
        .status-badge {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;
        }
        .status-badge.success { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); border: 1px solid rgba(63, 185, 80, 0.3); }
        .status-badge.error { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); border: 1px solid rgba(248, 81, 73, 0.3); }
        .status-badge.warning { background: rgba(210, 153, 34, 0.15); color: var(--accent-orange); border: 1px solid rgba(210, 153, 34, 0.3); }
        .status-badge.info { background: rgba(86, 212, 221, 0.15); color: var(--accent-cyan); border: 1px solid rgba(86, 212, 221, 0.3); }
        
        .config-grid { display: grid; gap: 0.75rem; }
        
        .config-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; background: var(--bg-tertiary); border-radius: 8px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
        }
        .config-item .label { color: var(--text-secondary); }
        .config-item .value { color: var(--accent-primary); }
        .config-item .value.masked { color: var(--text-secondary); }
        
        .teams-list { list-style: none; }
        .teams-list li {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; background: var(--bg-tertiary); border-radius: 8px;
            margin-bottom: 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
        }
        .team-key { background: var(--bg-primary); padding: 0.25rem 0.5rem; border-radius: 4px; color: var(--accent-purple); font-size: 0.8rem; }
        .team-id { color: var(--text-secondary); font-size: 0.8rem; margin-left: auto; }
        
        .endpoint-box { background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; font-family: 'JetBrains Mono', monospace; margin-bottom: 1rem; }
        .endpoint-box code { color: var(--accent-green); word-break: break-all; }
        .endpoint-box.highlight { border: 1px solid var(--accent-cyan); background: rgba(86, 212, 221, 0.05); }
        .endpoint-box .copy-hint { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem; }
        
        .error-list { list-style: none; }
        .error-list li {
            padding: 0.75rem 1rem; background: rgba(248, 81, 73, 0.1);
            border-left: 3px solid var(--accent-red); border-radius: 0 8px 8px 0;
            margin-bottom: 0.5rem; color: var(--accent-red);
        }
        
        .instructions { color: var(--text-secondary); line-height: 1.8; }
        .instructions ol { padding-left: 1.5rem; margin-top: 1rem; }
        .instructions li { margin-bottom: 0.5rem; }
        .instructions code {
            background: var(--bg-tertiary); padding: 0.15rem 0.4rem; border-radius: 4px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent-primary);
        }
        
        .tunnel-info {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;
            background: rgba(86, 212, 221, 0.1); border: 1px solid rgba(86, 212, 221, 0.3);
            border-radius: 8px; margin-bottom: 1rem;
        }
        .tunnel-info .icon { font-size: 1.2rem; }
        .tunnel-info .text { color: var(--accent-cyan); font-size: 0.9rem; }
        
        footer { text-align: center; margin-top: 3rem; color: var(--text-secondary); font-size: 0.9rem; }
        footer a { color: var(--accent-primary); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        
        .copy-btn {
            background: var(--accent-primary); color: white; border: none;
            padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer;
            font-size: 0.8rem; font-weight: 500; margin-left: 0.5rem;
            transition: opacity 0.2s;
        }
        .copy-btn:hover { opacity: 0.85; }
        
        /* Activity Log Styles */
        .activity-stats {
            display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;
        }
        .stat-box {
            background: var(--bg-tertiary); padding: 0.75rem 1rem; border-radius: 8px;
            display: flex; flex-direction: column; min-width: 80px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-box:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-primary); }
        .stat-value.success { color: var(--accent-green); }
        .stat-value.error { color: var(--accent-red); }
        .stat-value.webhooks { color: var(--accent-cyan); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        
        .activity-log { 
            max-height: 450px; overflow-y: auto; 
            min-height: 120px;
        }
        .activity-log::-webkit-scrollbar { width: 6px; }
        .activity-log::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .activity-log::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .activity-log::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        .activity-loading { 
            color: var(--text-secondary); padding: 2rem; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
        }
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid var(--border-color); border-top-color: var(--accent-primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .activity-empty { 
            color: var(--text-secondary); padding: 3rem; text-align: center;
            background: var(--bg-tertiary); border-radius: 8px; border: 2px dashed var(--border-color);
        }
        .activity-empty-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }
        
        .activity-item {
            display: flex; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px;
            margin-bottom: 0.5rem; background: var(--bg-tertiary); align-items: flex-start;
            border-left: 3px solid transparent;
        }
        .activity-item:hover { background: var(--bg-primary); }
        .activity-item.success { border-left-color: var(--accent-green); }
        .activity-item.error { border-left-color: var(--accent-red); }
        .activity-item.warning { border-left-color: var(--accent-orange); }
        .activity-item.info { border-left-color: var(--accent-primary); }
        
        .activity-icon {
            width: 36px; height: 36px; border-radius: 8px; display: flex;
            align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;
        }
        .activity-icon.success { background: rgba(63, 185, 80, 0.2); }
        .activity-icon.error { background: rgba(248, 81, 73, 0.2); }
        .activity-icon.warning { background: rgba(210, 153, 34, 0.2); }
        .activity-icon.info { background: rgba(88, 166, 255, 0.2); }
        
        .activity-content { flex: 1; min-width: 0; }
        .activity-message { font-weight: 500; margin-bottom: 0.25rem; word-break: break-word; }
        .activity-details { font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; line-height: 1.6; }
        .activity-details code { background: var(--bg-primary); padding: 0.1rem 0.4rem; border-radius: 3px; color: var(--accent-purple); }
        .activity-tag {
            display: inline-block; font-size: 0.7rem; padding: 0.15rem 0.4rem;
            border-radius: 4px; margin-right: 0.5rem; font-weight: 500; text-transform: uppercase;
        }
        .activity-tag.severity-critical { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .activity-tag.severity-high { background: rgba(248, 81, 73, 0.15); color: #ff7b72; }
        .activity-tag.severity-medium { background: rgba(210, 153, 34, 0.2); color: var(--accent-orange); }
        .activity-tag.severity-low { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .activity-time { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; }
        
        .refresh-btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary);
            padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer;
            font-size: 0.8rem; font-weight: 500; transition: all 0.2s ease;
            display: inline-flex; align-items: center; gap: 0.4rem;
        }
        .refresh-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--accent-primary); }
        .refresh-btn .icon { transition: transform 0.3s ease; }
        .refresh-btn.loading .icon { animation: spin 0.6s linear infinite; }
        
        .live-indicator {
            display: inline-flex; align-items: center; gap: 0.5rem;
            font-size: 0.75rem; color: var(--accent-green);
        }
        .live-dot {
            width: 8px; height: 8px; background: var(--accent-green);
            border-radius: 50%; animation: pulse 2s infinite;
        }
        .live-indicator.paused .live-dot { background: var(--text-secondary); animation: none; }
        .live-indicator.paused { color: var(--text-secondary); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }
        
        /* Fade transition for smooth updates */
        .activity-log.updating { opacity: 0.7; transition: opacity 0.15s; }
        
        /* Setup reminder banner */
        .setup-banner {
            background: linear-gradient(135deg, rgba(210, 153, 34, 0.15), rgba(163, 113, 247, 0.15));
            border: 1px solid var(--accent-orange);
            border-radius: 8px; padding: 1rem 1.5rem;
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;
        }
        .setup-banner-icon { font-size: 1.5rem; }
        .setup-banner-content { flex: 1; }
        .setup-banner-title { font-weight: 600; color: var(--accent-orange); }
        .setup-banner-text { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .setup-banner-btn {
            background: var(--accent-orange); color: var(--bg-primary); border: none;
            padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;
            font-weight: 500; font-size: 0.9rem; transition: opacity 0.2s;
        }
        .setup-banner-btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <span class="logo">üîí</span>
                <span class="logo">‚Üí</span>
                <span class="logo">üìã</span>
            </div>
            <h1>Semgrep ‚Üí Linear Integration</h1>
            <p class="subtitle">Automatically create Linear issues from Semgrep security findings</p>
        </header>
        
        {% if not linear_connected and validation_errors %}
        <div class="setup-banner">
            <div class="setup-banner-icon">‚ö†Ô∏è</div>
            <div class="setup-banner-content">
                <div class="setup-banner-title">Configuration Required</div>
                <div class="setup-banner-text">Complete the setup wizard to connect to Linear and start receiving tickets.</div>
            </div>
            <a href="/setup" class="setup-banner-btn">Open Setup</a>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h2>üîå Connection Status</h2>
                {% if linear_connected %}
                <span class="status-badge success">‚óè Connected</span>
                {% elif validation_errors %}
                <span class="status-badge error">‚óè Configuration Error</span>
                {% else %}
                <span class="status-badge warning">‚óè Disconnected</span>
                {% endif %}
            </div>
            
            {% if validation_errors %}
            <ul class="error-list">
                {% for error in validation_errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        
        {% if tunnel_active %}
        <div class="card">
            <div class="card-header">
                <h2>üöá Local Development Tunnel</h2>
                <span class="status-badge info">‚óè Active</span>
            </div>
            <div class="tunnel-info">
                <span class="icon">‚ú®</span>
                <span class="text">ngrok tunnel is running - your local server is publicly accessible!</span>
            </div>
            <div class="endpoint-box highlight">
                <code id="webhook-url">{{ webhook_url }}</code>
                <button class="copy-btn" onclick="copyToClipboard()">Copy</button>
                <div class="copy-hint">üëÜ Use this URL in Semgrep webhook configuration</div>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h2>‚öôÔ∏è Configuration</h2>
            </div>
            <div class="config-grid">
                <div class="config-item">
                    <span class="label">LINEAR_API_KEY</span>
                    <span class="value {% if not config.LINEAR_API_KEY %}masked{% endif %}">
                        {{ "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + config.LINEAR_API_KEY[-6:] if config.LINEAR_API_KEY else "Not configured" }}
                    </span>
                </div>
                <div class="config-item">
                    <span class="label">LINEAR_TEAM_ID</span>
                    <span class="value">{{ config.LINEAR_TEAM_ID or "Not configured" }}</span>
                </div>
                <div class="config-item">
                    <span class="label">LINEAR_PROJECT_ID</span>
                    <span class="value">{{ config.LINEAR_PROJECT_ID or "Optional - Not set" }}</span>
                </div>
                <div class="config-item">
                    <span class="label">WEBHOOK_SECRET</span>
                    <span class="value {% if not webhook_configured %}masked{% endif %}">
                        {{ "Configured ‚úì" if webhook_configured else "Not configured (optional)" }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>üéØ Webhook Endpoint</h2>
            </div>
            {% if not tunnel_active %}
            <div class="endpoint-box">
                <code>{{ webhook_url or "POST /webhook" }}</code>
            </div>
            {% endif %}
            <div class="instructions">
                <ol>
                    <li>In Semgrep AppSec Platform, go to <strong>Settings ‚Üí Integrations ‚Üí Add</strong></li>
                    <li>Select <strong>Webhook</strong> and enter: <code>{{ webhook_url }}</code></li>
                    <li>Set a Signature Secret matching your <code>SEMGREP_WEBHOOK_SECRET</code></li>
                    <li>Enable the webhook and configure which rule modes trigger notifications</li>
                </ol>
            </div>
        </div>
        
        {% if teams %}
        <div class="card">
            <div class="card-header">
                <h2>üë• Available Teams</h2>
            </div>
            <ul class="teams-list">
                {% for team in teams %}
                <li>
                    <span class="team-key">{{ team.key }}</span>
                    {{ team.name }}
                    <span class="team-id">{{ team.id }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <!-- Activity Log -->
        <div class="card">
            <div class="card-header">
                <h2>üìä Activity Log</h2>
                <div class="header-actions">
                    <span class="live-indicator" id="live-indicator">
                        <span class="live-dot"></span>
                        <span class="live-text">Live</span>
                    </span>
                    <button class="refresh-btn" id="refresh-btn" onclick="manualRefresh()">
                        <span class="icon">‚Üª</span> Refresh
                    </button>
                </div>
            </div>
            <div id="activity-stats" class="activity-stats">
                <div class="stat-box"><div class="stat-value webhooks">-</div><div class="stat-label">Webhooks</div></div>
                <div class="stat-box"><div class="stat-value success">-</div><div class="stat-label">Tickets</div></div>
                <div class="stat-box"><div class="stat-value error">-</div><div class="stat-label">Errors</div></div>
                <div class="stat-box"><div class="stat-value">-</div><div class="stat-label">Total</div></div>
            </div>
            <div id="activity-log" class="activity-log">
                <div class="activity-loading"><div class="spinner"></div> Loading activities...</div>
            </div>
        </div>
        
        <footer>
            Built for security teams ‚Ä¢ 
            <a href="/setup">Setup Wizard</a> ‚Ä¢ 
            <a href="/health">Health Check</a> ‚Ä¢ 
            <a href="/api/tunnel/status">Tunnel Status</a>
        </footer>
    </div>
    
    <script>
        // ========================================
        // Activity Log Manager - Production Quality
        // ========================================
        
        const ActivityLog = {
            // State
            activities: [],
            stats: null,
            lastHash: null,
            isLoading: false,
            hasInitialized: false,
            refreshInterval: null,
            REFRESH_INTERVAL_MS: 8000, // 8 seconds
            
            // DOM Elements (cached)
            elements: {
                log: null,
                stats: null,
                refreshBtn: null,
                liveIndicator: null
            },
            
            // Initialize
            init() {
                this.elements.log = document.getElementById('activity-log');
                this.elements.stats = document.getElementById('activity-stats');
                this.elements.refreshBtn = document.getElementById('refresh-btn');
                this.elements.liveIndicator = document.getElementById('live-indicator');
                
                // Initial load
                this.fetchActivities(true);
                
                // Start auto-refresh
                this.startAutoRefresh();
                
                // Pause when tab is hidden, resume when visible
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stopAutoRefresh();
                        this.setLiveStatus(false);
                    } else {
                        this.startAutoRefresh();
                        this.setLiveStatus(true);
                        this.fetchActivities(false); // Refresh on return
                    }
                });
            },
            
            // Compute hash for change detection
            computeHash(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            },
            
            // Fetch activities from API
            async fetchActivities(isInitial = false) {
                if (this.isLoading) return;
                this.isLoading = true;
                
                if (isInitial) {
                    this.setRefreshLoading(true);
                }
                
                try {
                    const response = await fetch('/api/activity?limit=50');
                    if (!response.ok) throw new Error('Failed to fetch');
                    
                    const data = await response.json();
                    const newHash = this.computeHash(data);
                    
                    // Only update DOM if data changed
                    if (newHash !== this.lastHash || isInitial) {
                        this.activities = data.activities || [];
                        this.stats = data.stats || {};
                        this.lastHash = newHash;
                        
                        this.renderStats();
                        this.renderActivities(isInitial);
                    }
                    
                    this.hasInitialized = true;
                    
                } catch (error) {
                    console.error('Activity fetch error:', error);
                    if (!this.hasInitialized) {
                        this.renderError();
                    }
                } finally {
                    this.isLoading = false;
                    this.setRefreshLoading(false);
                }
            },
            
            // Render stats
            renderStats() {
                const webhooks = this.stats.by_type?.webhook_received || 0;
                const tickets = this.stats.by_type?.issue_created || 0;
                const errors = this.stats.errors || 0;
                const total = this.stats.total || 0;
                
                this.elements.stats.innerHTML = `
                    <div class="stat-box"><div class="stat-value webhooks">${webhooks}</div><div class="stat-label">Webhooks</div></div>
                    <div class="stat-box"><div class="stat-value success">${tickets}</div><div class="stat-label">Tickets</div></div>
                    <div class="stat-box"><div class="stat-value error">${errors}</div><div class="stat-label">Errors</div></div>
                    <div class="stat-box"><div class="stat-value">${total}</div><div class="stat-label">Total</div></div>
                `;
            },
            
            // Render activities
            renderActivities(animate = false) {
                if (this.activities.length === 0) {
                    this.elements.log.innerHTML = `
                        <div class="activity-empty">
                            <div class="activity-empty-icon">üì≠</div>
                            <div>No activity yet</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Trigger a Semgrep scan to see webhook events here</div>
                        </div>
                    `;
                    return;
                }
                
                const html = this.activities.map(item => this.renderActivityItem(item)).join('');
                this.elements.log.innerHTML = html;
            },
            
            // Render single activity item
            renderActivityItem(item) {
                const details = item.details || {};
                let detailsHtml = this.buildDetailsHtml(item.type, details);
                
                return `
                    <div class="activity-item ${item.status}">
                        <div class="activity-icon ${item.status}">${this.getIcon(item.type)}</div>
                        <div class="activity-content">
                            <div class="activity-message">${this.escapeHtml(item.message)}</div>
                            ${detailsHtml ? `<div class="activity-details">${detailsHtml}</div>` : ''}
                        </div>
                        <div class="activity-time">${this.formatTime(item.timestamp)}</div>
                    </div>
                `;
            },
            
            // Build details HTML based on event type
            buildDetailsHtml(type, details) {
                switch (type) {
                    case 'issue_created':
                        let html = this.getSeverityTag(details.severity);
                        if (details.issue_id) html += `<code>${this.escapeHtml(details.issue_id)}</code>`;
                        if (details.file) html += ` ‚Üí <code>${this.escapeHtml(this.shortPath(details.file))}</code>`;
                        if (details.repo) html += ` in ${this.escapeHtml(details.repo)}`;
                        return html;
                        
                    case 'issue_skipped':
                        let skipHtml = '';
                        if (details.rule) skipHtml = `Rule: <code>${this.escapeHtml(details.rule)}</code>`;
                        if (details.file) skipHtml += ` ‚Ä¢ ${this.escapeHtml(this.shortPath(details.file))}`;
                        return skipHtml;
                        
                    case 'webhook_received':
                        let webhookHtml = '';
                        if (details.method) webhookHtml = `Method: ${details.method}`;
                        if (details.finding_count) webhookHtml += ` ‚Ä¢ ${details.finding_count} findings`;
                        return webhookHtml;
                        
                    case 'scan_completed':
                        return details.findings_count !== undefined 
                            ? `${details.findings_count} findings detected` 
                            : '';
                        
                    case 'startup':
                        return details.public_url 
                            ? `<code>${this.escapeHtml(details.public_url)}</code>` 
                            : '';
                        
                    default:
                        if (details.error) {
                            const errorText = details.error.substring(0, 120);
                            return `<span style="color: var(--accent-red);">${this.escapeHtml(errorText)}${details.error.length > 120 ? '...' : ''}</span>`;
                        }
                        if (details.file) {
                            let fileHtml = `<code>${this.escapeHtml(this.shortPath(details.file))}</code>`;
                            if (details.rule) fileHtml += ` ‚Ä¢ ${this.escapeHtml(details.rule)}`;
                            return fileHtml;
                        }
                        return '';
                }
            },
            
            // Render error state
            renderError() {
                this.elements.log.innerHTML = `
                    <div class="activity-empty">
                        <div class="activity-empty-icon">‚ö†Ô∏è</div>
                        <div>Failed to load activities</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">Check your connection and try again</div>
                    </div>
                `;
            },
            
            // Helper: Get icon for event type
            getIcon(type) {
                const icons = {
                    'issue_created': 'üé´',
                    'issue_skipped': '‚è≠Ô∏è',
                    'issue_failed': '‚ùå',
                    'webhook_received': 'üì•',
                    'scan_completed': 'üîç',
                    'startup': 'üöÄ',
                    'signature_missing': 'üîê',
                    'error': 'üö®'
                };
                return icons[type] || 'üìã';
            },
            
            // Helper: Format relative time
            formatTime(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const diff = (now - date) / 1000;
                
                if (diff < 10) return 'just now';
                if (diff < 60) return Math.floor(diff) + 's ago';
                if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
                if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            },
            
            // Helper: Severity tag
            getSeverityTag(severity) {
                if (!severity) return '';
                const s = severity.toLowerCase();
                return `<span class="activity-tag severity-${s}">${s}</span>`;
            },
            
            // Helper: Shorten file path
            shortPath(path) {
                if (!path) return '';
                const parts = path.split('/');
                return parts.slice(-2).join('/');
            },
            
            // Helper: Escape HTML
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            // UI: Set refresh button loading state
            setRefreshLoading(loading) {
                if (loading) {
                    this.elements.refreshBtn.classList.add('loading');
                } else {
                    this.elements.refreshBtn.classList.remove('loading');
                }
            },
            
            // UI: Set live indicator status
            setLiveStatus(isLive) {
                if (isLive) {
                    this.elements.liveIndicator.classList.remove('paused');
                    this.elements.liveIndicator.querySelector('.live-text').textContent = 'Live';
                } else {
                    this.elements.liveIndicator.classList.add('paused');
                    this.elements.liveIndicator.querySelector('.live-text').textContent = 'Paused';
                }
            },
            
            // Auto-refresh management
            startAutoRefresh() {
                if (this.refreshInterval) return;
                this.refreshInterval = setInterval(() => {
                    this.fetchActivities(false);
                }, this.REFRESH_INTERVAL_MS);
                this.setLiveStatus(true);
            },
            
            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            }
        };
        
        // Manual refresh handler
        function manualRefresh() {
            ActivityLog.setRefreshLoading(true);
            ActivityLog.fetchActivities(true);
        }
        
        // Copy webhook URL
        function copyToClipboard() {
            const urlEl = document.getElementById('webhook-url');
            if (!urlEl) return;
            
            const url = urlEl.textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            ActivityLog.init();
        });
    </script>
</body>
</html>
